AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: "Lambda Instagram Followers Chart"

Resources:
  ScraperFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: bin
      Handler: scraper
      Runtime: go1.x
      Timeout: 300
      Policies:
      - S3CrudPolicy:
        BucketName: !Ref LogsBucket

      Environment:
        Variables:
          IG_USERNAME: ""
          TARGET_S3_ARN: !Sub ${LogsBucket.Arn}
          LOGS_BUCKET: !Ref LogsBucket

      Policies:
        - AWSLambdaExecute
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
              - s3:GetObject
              - s3:DeleteObject
              - s3:PutObject
              Resource: !Sub ${LogsBucket.Arn}/*

  ScheduledScraper:
    Type: AWS::Events::Rule
    Properties:
      ScheduleExpression: "cron(0 0 ? * * *)"
      State: ENABLED
      Targets:
        -
          Arn:
            Fn::GetAtt:
              - ScraperFunction
              - Arn
          Id: TargetFunctionV1
    
  LogsBucket:
    Type: AWS::S3::Bucket

Outputs:
  LogsBucket:
    Description: "S3 Bucket name that keeps logs and chart"
    Value: !Ref LogsBucket